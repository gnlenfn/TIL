# 서브쿼리

State: Complete
유형: SQL
최종 편집: 2021년 10월 15일 오후 12:30

## 서브쿼리란?

- 하나의 SQL문에 포함된 또다른 SQL문
- 비교연산자의 오른쪽에 위치해야하고 반드시 괄호 안에 넣어야 함
- 메인 쿼리가 실행되기 전, 한 번만 실행됨

## 서브쿼리 사용 가능한 곳

- **SELECT**
- **FROM**
- **WHERE**
- HAVING
- ORDER BY
- INSERT의 VALUES
- UPDATE의 SET

### SELECT의 서브쿼리

스칼라 서브쿼리라고 불리며, 서브쿼리의 결과는 반드시 단일 행이나 단일 값으로 리턴되어야 한다. 서브쿼리를 끝마친 하나의 값을 메인 쿼리에서 SELECT하기 때문

```sql
SELECT 학생이름,
    ( SELECT 학과.학과이름
        FROM 학과
        WHERE 학과.학과ID = 학생.학생ID ) AS 학과이름
FROM 학생
WHERE 학생이름 = '홍길동';
```

괄호 안의 서브쿼리 부분이 학과 이름을 리턴한다.

### FROM의 서브쿼리

인라인뷰 라고 불리며 서브쿼리의 결과는 하나의 테이블을 리턴한다. 

```sql
SELECT 학생이름, 수학점수
FROM ( SELECT 학생.학생이름 AS 학생이름,
			과목.과목점수 AS 수학점수
			FROM 학생, 과목
			WHERE 학생.학생이름 = 과목.학생이름
			AND 과목.과목이름 = '수학') ;
```

서브쿼리가 학생의 이름과 수학과목의 점수를 보여주는 테이블을 리턴한다.

### WHERE의 서브쿼리

중첩 서브쿼리라고 불리며 가장 대중적인 서브쿼리이다. 단일 행, 복수 행 모두 리턴 가능.

서브쿼리의 결과를 메인쿼리의 조건절을 통해 비교

```sql
SELECT *
FROM 학생
WHERE 학생.학생이름 IN ( SELECT 과목.학생이름 FROM 과목 WHERE 과목.과목이름 = '수학');
```

단일 행과 복수 행은 무슨 차이가 있나?

## 단일 행 서브쿼리와 다중 행 서브쿼리

### 단일 행

- 서브쿼리의 결과가 하나의 ROW만 리턴
- 이 리턴을 가지고 메인쿼리는 비교연산자를 통해 쿼리를 수행
- 비교연산자 `>, >=, <, <=, = etc...`

```sql
SELECT Name, SAL
FROM EMP
WHERE SAL > (SELECT AVG(SAL) FROM EMP);
```

### 다중 행

- 서브쿼리의 결과가 두 개 이상의 ROW를 포함
- **다중행 비교연산자를 사용**
- `IN, ANY, SOME, ALL, EXISTS`

### 다중 행 비교연산자

1. **IN** : 메인쿼리 비교조건이 서브쿼리의 결과 중 하나라도 일치하면 True
2. **ALL** : 메인쿼리 비교조건이 서브쿼리의 결과와 모두 일치하면 True
    - ex) 메인 쿼리 < ALL (서브쿼리) : 서브쿼리의 결과와 비교하여 최소값 반환
    
    ```sql
    // ex ) 30번 소속 사원들 중 급여를 가장 많이 받는 사원보다 더 많은 급여를 받는 사람의 이름과 급여를 출력
    SELECT  ENAME, SAL
      FROM  EMP
     WHERE  SAL > ALL ( SELECT  SAL
                          FROM  EMP
                         WHERE  DEPTNO = 30 );
    ```
    
3. **ANY** : 메인쿼리의 비교조건이 서브쿼리의 결과와 하나 이상 일치하면 True
    - 메인쿼리 < ANY (서브쿼리) : 서브쿼리의 결과와 비교해 메인쿼리의 데이터중 하나라도 서브쿼리의 결과보다 작다면 최소값 반환
    
4. EXISTS
    - 메인쿼리의 비교조건이 서브쿼리의 결과 중 하나라도 만족하는 값이 있으면 True
    - 해당 ROW의 존재 여부만 확인
    - IN은 실제 존재하는 데이터들의 모든 값까지 확인
    - NOT EXISTS는 메인의 컬럼명과 서브의 컬럼명을 비교하여 일치하지 않으면 메인쿼리 테이블의 모든 ROW 리턴